# TXT to EPUB (青龙面板版)

这是一个为青龙面板定制的 Python 脚本，用于将 TXT 格式的小说文件批量转换为 EPUB 格式。

它会自动扫描指定目录，匹配封面和元数据（作者、简介），最后通过青龙的通知系统（如 Bark）推送转换结果。

## ✨ 主要功能与特点

本项目的主要功能是将 `.txt` 文件批量转换为 `.epub` 格式，并针对青龙面板环境进行了深度优化。其核心功能点包括：

- **批量处理**：自动扫描指定输入目录 (`INPUT_DIR`) 下的所有 `.txt` 文件。
- **青龙集成**：专为青龙面板设计，通过环境变量读取配置，通过 `notify.py` 发送通知。
- **智能章节检测**：支持多种复杂的章节标题格式（如 `第...章`、`# 标题`、`1. 标题` 等），并能智能规避正文中的干扰项（如 `第四节课`）。
- **封面自动匹配**：自动从封面目录 (`COVER_DIR`) 查找与小说文件名同名的封面图片（如 `小说.txt` -\> `小说.jpg`）。
- **元数据支持**：通过 `metadata.json` 文件为每本书籍灵活配置专属的**作者**和**简介**。
- **结果通知**：在任务执行完毕后，会列出所有成功和失败的书籍列表，并通过青龙面板的通知渠道（如 Bark）发送给你。
- **编码自动检测**：自动检测 `.txt` 文件的编码（UTF-8, GBK 等），避免乱码。

## 🚀 青龙面板部署

#### 1\. 拉取仓库

在青龙面板的 "定时任务" -\> "添加任务"，输入以下命令并执行一次，以拉取仓库：

```bash
ql repo https://github.com/zz2213/QingLong_txt2epub
```


#### 2\. 安装依赖

在青龙面板的 "依赖管理" -\> "Python3" 标签页中，添加以下两个依赖项并等待安装完成：

- `EbookLib`
- `chardet`

#### 3\. 配置环境变量

在青龙面板的 "环境变量" -\> "添加变量"，添加以下配置项：

| 变量名 | 是否必填 | 说明 |
| :--- | :--- | :--- |
| `INPUT_DIR` | **必填** | 存放 `.txt` 小说文件的**绝对路径**。 (例如: `/ql/data/txt/`) |
| `OUTPUT_DIR` | **必填** | 存放生成的 `.epub` 文件的**绝对路径**。 (例如: `/ql/data/epub/`) |
| `COVER_DIR` | 可选 | 存放封面图片的**绝对路径**。脚本将在此查找同名文件。 |
| `METADATA_FILE_PATH` | 可选 | `metadata.json` 文件的**绝对路径**。 (见下方说明) |
| `AUTHOR` | 可选 | 全局默认作者。如果 `metadata.json` 中未指定作者，将使用此值。 |

*(**提示**：章节检测相关的环境变量（如 `CHAPTER_DETECTION_METHOD`）也依然有效，但通常保持默认即可。)*

#### 4\. (可选) 创建元数据文件 `metadata.json`

这是本脚本的核心功能。如果你想为特定书籍指定作者或简介，请：

1.  在你的服务器上（例如 `/ql/data/config/`）创建一个 `metadata.json` 文件。

2.  按照以下格式填入内容（**键** 必须与 **TXT文件名** (不含`.txt`) **完全一致**）：

    ```json
    {
      "斗破苍穹": {
        "author": "天蚕土豆",
        "description": "三十年河东，三十年河西，莫欺少年穷！"
      },
      "凡人修仙传": {
        "author": "忘语",
        "description": "一个普通山村小子，偶然下进入到当地江湖小门派..."
      },
      "没有简介的书": {
        "author": "某作者"
      },
      "使用全局作者的书": {
        "description": "这本书会使用你在环境变量里配置的全局 AUTHOR。"
      }
    }
    ```

3.  在青龙环境变量中设置 `METADATA_FILE_PATH`，指向这个文件的**绝对路径** (例如: `/ql/data/config/metadata.json`)。

#### 5\. 配置通知

脚本会自动调用青龙的 `notify.py` 模块。

你**不需要**在脚本里做任何事，只需要在青龙面板的 "系统设置" -\> "通知设置" 中，配置好你想要的通知方式（例如 Bark, Telegram Bot, 微信等）。脚本执行完毕后，结果会自动推送。

#### 6\. 添加定时任务

在青龙面板的 "定时任务" -\> "添加任务"，设置你的任务：

- **名称**：`批量小说转换`
- **命令**：`python3 run_qinglong.py`
- **定时**：例如 `0 3 * * *` （每天凌晨3点执行）

*(**重要**：请确保你的命令指向的是包含 `run_qinglong.py` 的那个仓库目录。如果你的仓库名是 `Novel_Converter_txt2epub`，并且你拉取到了 `ql/data/repo/` 目录下，那么完整命令可能是 `python3 /ql/data/repo/Novel_Converter_txt2epub/run_qinglong.py`。你可以在 "定时任务" 页面的日志中确认路径是否正确。)*

## 📁 项目结构

项目文件经过重构，以适配青龙面板的批量执行流程：

```
QingLong_txt2epub/
├── run_qinglong.py       # (核心) 青龙面板的主执行入口
├── QL_logger.py          # (核心) 统一日志记录器
├── metadata.json         # (配置) 用户需自行创建的元数据文件 (示例)
├── README.md             # (文档) 你正在阅读的文件
├── src/                  # 源代码目录
│   ├── __init__.py
│   ├── main.py           # 组合EPUB创建的核心逻辑
│   ├── config.py         # (核心) 环境变量配置读取
│   ├── chapter_parser.py # (核心) 智能章节解析器
│   └── epub_builder.py   # (核心) EPUB文件构建器
└──
```

## 📖 工作流程

1.  脚本启动 (`run_qinglong.py`)。
2.  读取所有环境变量，并加载 `metadata.json` (如果配置了)。
3.  扫描 `INPUT_DIR` 目录下的所有 `*.txt` 文件。
4.  **循环处理** 每一个文件（例如 `小说A.txt`）：
* **书名**：`小说A`
* **元数据**：在 `metadata.json` 中查找 "小说A" 对应的 `author` 和 `description`。如果找不到，`author` 使用全局 `AUTHOR`。
* **封面**：在 `COVER_DIR` 目录中查找 `小说A.jpg`, `小说A.png` 或 `小说A.jpeg`。
* **解析**：使用 `chapter_parser.py` 分析章节。
* **生成**：将所有内容（包括简介页）打包成 `小说A.epub`，并保存到 `OUTPUT_DIR`。
5.  所有文件处理完毕后，生成一份包含成功列表和失败列表的摘要。
6.  调用青龙 `send()` 函数，将摘要发送到 Bark 等通知工具。

## 🔍 支持的章节格式

解析器 (`src/chapter_parser.py`) 支持以下格式（并已强化，防止误判）：

### 1\. 特殊字符标记 (推荐)

```
#第一章 故事开始
##第二章 情节发展
@第三章 高潮部分
```

### 2\. 数字格式 (严格匹配)

- `第1章 标题`
- `第 1 章 标题`
- `Chapter 1 标题`
- (不会匹配 `第四节课`)

### 3\. 中文数字格式 (严格匹配)

- `第一章 标题`
- `第一百章 标题`
- `第一节 标题`
- (不会匹配 `第四节课`)

### 4\. 其他格式

- `1. 标题`
- `1、标题`
- `一、标题`